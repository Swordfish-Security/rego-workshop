# K8s

## Рекомендуемый инструмент - Gatekeeper

Для применения OPA политик в Kubernetes, рекомендуется использовать инструмент Gatekeeper. В этой папке находятся примеры именно для него.

Gatekeeper - инструмент для управления политиками в кластере Kubernetes. Он представляет собой настраиваемый веб-хук, который перехватывает запросы до их сохранения в etcd и используется в качестве изменяющего (mutating) или проверяющего (validating) хука. В дополнение к функции управления допуском (admission control), функция аудита Gatekeeper позволяет видеть, какие ресурсы в данный момент нарушают ту или иную политику.

Gatekeeper опирается на политики OPA с помощью [кастомных определений ресурсов](https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/) (Custom Resource Definition, CRD), чтобы отклонять или принимать запросы.

### Шаблоны ограничений (Constraint Templates)

Политики в Gatekeeper описываются с помощью ограничений (constraint). Прежде чем определить ограничение, необходимо сначала определить шаблон ограничения (ConstraintTemplate), который описывает как Rego, обеспечивающее выполнение ограничения, так и схему ограничения. Схема ограничения позволяет настроить поведение ограничения, а именно - указать принимаемые значения, подобно аргументам функции.

Шаблон - это макет, который будут уточнять ограничения, использующие его. Например, необходимо, чтобы все ресурсы имели метку `gatekeeper`. Для этого сначала необходимо создать шаблон ограничения, где будет указано, **что** нужно проверить (метку) и **каким образом** (метка проверяемого объекта должна совпадать с той, которую мы зададим). Далее можно создать ограничение, где будет описано **какие именно** метки должны быть у объекта.

### Ограничения (Constraints)

После описания шаблона можно создавать само ограничение. Они используются для того, чтобы сообщить Gatekeeper, что администратор хочет, чтобы этот шаблон применялся и применялся он определенным образом.

По сути, ограничение — это CRD, создаваемое из шаблона ограничения. То есть Gatekeeper будет создавать новое CRD для описания каждой определяемой политики.

## Задание

### Проверка наличия requests у всех контейнеров

__Задание__: написать политику, которая проверяет, что у манифеста пода (`kind: Pod`) для каждого из контейнеров указан request.

## Описание папки

В папке `example` находится пример Constraint Template и сам Constraint на основе задания выше. Кроме этого имеется под и деплоймент, которые будут нарушать заданные в предыдущих файлах политики.

В файле `conftest.rego` приведён пример этой политики для conftest.

Для демонстрации примера необходимо иметь установленный в кластере [Gatekeeper](https://github.com/open-policy-agent/gatekeeper) и права кластер-админа.

Применять манифесты необходимо по очереди, чтобы Kubernetes успел создать CRD:
```sh
kubectl apply -f example/1-constraint-template.yaml
kubectl apply -f example/2-constraint.yaml
kubectl apply -f example/3-bad-pod.yaml
kubectl apply -f example/4-bad-deployment.yaml # По желанию
```